<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ë–£–†–ê–ù-4 // TECHNICAL PASSPORT v0.4</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --green: #0f0;
      --dark: #0a0a0a;
      --darker: #030303;
      --red: #f33;
      --amber: #ffaa00;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background-color: var(--darker);
      color: var(--green);
      font-family: 'Share Tech Mono', monospace;
      overflow: hidden;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .monitor {
      width: 94vw;
      max-width: 900px;
      height: 94vh;
      background-color: var(--dark);
      border: 10px solid #111;
      box-shadow: 
        0 0 30px rgba(0, 80, 0, 0.7), 
        inset 0 0 15px rgba(0, 40, 0, 0.8),
        inset 0 0 40px rgba(0, 20, 0, 0.3);
      position: relative;
      overflow: hidden;
      padding: 20px;
      border-radius: 4px;
      font-size: 15px;
    }

    /* CRT scanline */
    .monitor::before {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(rgba(0, 30, 0, 0.08), transparent 95%);
      pointer-events: none;
      animation: scanline 9s linear infinite;
    }

    @keyframes scanline {
      0% { background-position: 0 0; }
      100% { background-position: 0 100vh; }
    }

    .header {
      text-align: center;
      margin-bottom: 18px;
      font-family: 'Orbitron', sans-serif;
      font-size: 1.5rem;
      text-shadow: 0 0 6px rgba(0, 255, 0, 0.8), 0 0 12px rgba(0, 120, 0, 0.6);
      letter-spacing: 2px;
      position: relative;
    }

    .terminal {
      line-height: 1.6;
      height: calc(100% - 140px);
      overflow-y: auto;
      padding: 12px;
      color: var(--green);
      text-shadow: 0 0 3px rgba(0, 60, 0, 0.8);
      white-space: pre-wrap;
    }

    .blink { animation: blink 1s step-end infinite; }
    @keyframes blink { 50% { opacity: 0; } }

    .input-line {
      margin-top: 10px;
      display: flex;
      align-items: center;
    }

    .prompt::after {
      content: '‚ñà';
      margin-right: 8px;
      animation: blink 1s step-end infinite;
    }

    input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--green);
      font-family: 'Share Tech Mono', monospace;
      font-size: 1.1rem;
      outline: none;
      text-shadow: 0 0 3px rgba(0, 60, 0, 0.8);
    }

    .timestamp { color: #8f8; font-size: 0.85rem; opacity: 0.8; }
    .sys { color: #8af; }
    .err { color: var(--red); }
    .warn { color: var(--amber); }

    /* –ß–∞—Ç —Å —Ö–∞–∫–µ—Ä–æ–º */
    .chat-panel {
      position: absolute;
      top: 20px; right: 20px;
      width: 280px;
      height: 320px;
      background: rgba(5, 15, 5, 0.9);
      border: 2px solid var(--green);
      box-shadow: 0 0 8px rgba(0, 255, 0, 0.4);
      padding: 12px;
      font-size: 0.85rem;
      display: none;
      z-index: 10;
      overflow-y: auto;
    }

    .chat-panel.active { display: block; }
    .chat-msg { margin-bottom: 10px; line-height: 1.4; }
    .chat-msg.me { text-align: right; color: #afa; }
    .chat-msg.them { text-align: left; color: #8af; }
    .chat-header {
      text-align: center;
      font-weight: bold;
      margin-bottom: 8px;
      border-bottom: 1px dashed #0a0;
      padding-bottom: 4px;
      font-family: 'Orbitron', sans-serif;
    }

    /* XOR Puzzle */
    .xor-puzzle {
      display: none;
      margin-top: 20px;
      text-align: center;
    }

    .xor-puzzle.active { display: block; }
    .xor-grid {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
    }

    .xor-byte {
      width: 50px; height: 50px;
      background: #050;
      border: 1px solid #0a0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Orbitron';
      font-size: 1rem;
      cursor: grab;
      user-select: none;
    }

    .xor-byte.dragging { opacity: 0.6; }
    .xor-dropzone {
      width: 60px; height: 60px;
      border: 2px dashed #080;
      margin: 5px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }

    /* –ö–∞—Ä—Ç–∞ */
    .map-container {
      display: none;
      height: 300px;
      margin-top: 20px;
      background: #000;
      border: 1px solid #080;
      position: relative;
      overflow: hidden;
    }

    .map-container.active { display: block; }

    .map-svg {
      width: 100%; height: 100%;
      background: #001 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='300'%3E%3Crect width='100%25' height='100%25' fill='%23000510'/%3E%3Cpath d='M0,200 L200,180 L400,210 L600,190 L800,220' stroke='%230a0' stroke-width='2' fill='none'/%3E%3Ccircle cx='630' cy='195' r='8' fill='none' stroke='%23f33' stroke-width='2'/%3E%3Ctext x='640' y='190' fill='%23f33' font-size='12' font-family='monospace'%3EBURAN-4%3C/text%3E%3C/svg%3E") center/contain no-repeat;
    }

    .gps-tracker {
      position: absolute;
      top: 50%; left: 10%;
      width: 12px; height: 12px;
      background: #0f0;
      border-radius: 50%;
      box-shadow: 0 0 6px #0f0;
      transform: translate(-50%, -50%);
      transition: left 8s linear;
    }

    /* Reactor glow */
    .reactor-glow {
      position: absolute;
      bottom: 15px; left: 15px;
      display: flex;
      align-items: center;
      font-size: 0.9rem;
    }

    .glow-dot {
      width: 12px; height: 12px;
      background: #f33;
      border-radius: 50%;
      margin-right: 8px;
      box-shadow: 0 0 6px #f33;
      animation: pulse 2.2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    /* Passport export button */
    .export-btn {
      position: absolute;
      bottom: 15px; right: 15px;
      background: #111;
      color: var(--amber);
      border: 1px solid var(--amber);
      padding: 6px 12px;
      font-family: 'Orbitron';
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .export-btn:hover {
      background: #222;
      box-shadow: 0 0 8px rgba(255, 170, 0, 0.6);
    }

    /* PDF Passport (—Å–∫—Ä—ã—Ç—ã–π, –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞) */
    #passport {
      position: absolute;
      left: -9999px;
      width: 700px;
      padding: 40px;
      background: #0a0a0a;
      font-family: 'Cinzel', serif;
      color: #ccc;
      border: 4px double #888;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
    }

    .passport-header {
      text-align: center;
      font-size: 2.2rem;
      color: #f33;
      margin-bottom: 20px;
      text-shadow: 0 0 8px rgba(255, 50, 50, 0.6);
    }

    .passport-field {
      margin: 12px 0;
      font-size: 1.1rem;
    }

    .field-label { color: #8af; font-weight: bold; }
    .field-value { color: #afa; }

    .seal {
      text-align: center;
      margin-top: 30px;
      font-family: 'Orbitron';
      color: #f33;
      font-size: 1.4rem;
    }

    /* Mobile */
    @media (max-width: 650px) {
      .chat-panel, .map-container { width: 90vw; left: 50%; transform: translateX(-50%); }
      .chat-panel { top: auto; bottom: 100px; height: 200px; }
    }
  </style>
</head>
<body>

  <div class="monitor">
    <div class="header">
      [ TECH-PRIEST MONITORING TERMINAL v4.1 | BURAN-4 RECON ]
    </div>

    <div class="terminal" id="terminal"></div>

    <div class="input-line">
      <span class="prompt"></span>
      <input type="text" id="command-input" placeholder=">_"
        autocomplete="off" spellcheck="false">
    </div>

    <div class="reactor-glow">
      <div class="glow-dot"></div>
      <span>REACTOR CORE // NOMINAL (Œ¥ = 0.92)</span>
    </div>

    <button class="export-btn" id="export-pdf">üñ® EXPORT TECH-PASSPORT</button>

    <!-- –ß–∞—Ç —Å —Ö–∞–∫–µ—Ä–æ–º -->
    <div class="chat-panel" id="chat-panel">
      <div class="chat-header">> SECURE CHANNEL // PHANTOM</div>
      <div class="chat-messages" id="chat-messages"></div>
    </div>

    <!-- –ì–æ–ª–æ–≤–æ–ª–æ–º–∫–∞ XOR -->
    <div class="xor-puzzle" id="xor-puzzle">
      <div>DECRYPT KEY XOR.PAD ‚Äî DRAG BYTES TO RECONSTRUCT</div>
      <div class="xor-grid" id="xor-grid"></div>
      <div id="xor-result"></div>
      <button id="xor-submit">VERIFY CRC</button>
    </div>

    <!-- –ö–∞—Ä—Ç–∞ -->
    <div class="map-container" id="map-container">
      <div class="map-svg"></div>
      <div class="gps-tracker" id="gps-tracker"></div>
    </div>
  </div>

  <!-- –°–∫—Ä—ã—Ç—ã–π –ø–∞—Å–ø–æ—Ä—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
  <div id="passport">
    <div class="passport-header">ORDO MECHANICUS TECHNICAL PASSPORT</div>
    <div class="passport-field"><span class="field-label">NAME:</span> <span class="field-value">DANYA "ELECTRON" VOLKOV</span></div>
    <div class="passport-field"><span class="field-label">RANK:</span> <span class="field-value">SCRIBE-ANALYST (PROVISIONAL)</span></div>
    <div class="passport-field"><span class="field-label">MISSION:</span> <span class="field-value">BURAN-4 RECON / ZARYA-9 REACTOR</span></div>
    <div class="passport-field"><span class="field-label">COORDINATES:</span> <span class="field-value">45.6307¬∞N, 63.3322¬∞E</span></div>
    <div class="passport-field"><span class="field-label">AUTH. HASH:</span> <span class="field-value" id="passport-hash">7A3F...E9C1</span></div>
    <div class="passport-field"><span class="field-label">WARNINGS:</span> <span class="field-value">RADIATION ‚Ä¢ PSYCHIC ECHO ‚Ä¢ NO RETURN PROTOCOL</span></div>
    <div class="seal">‚ú† MACHINA SACRA ‚ú†</div>
  </div>

  <script>
    // === –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏–∑ CDN ===
    const { jsPDF } = window.jspdf;

    // === STATE ===
    let phase = localStorage.getItem('buran4_phase') || 'prelude';
    let chatActive = false;
    let xorSolved = false;
    let gpsRunning = false;

    const terminal = document.getElementById('terminal');
    const input = document.getElementById('command-input');
    const chatPanel = document.getElementById('chat-panel');
    const chatMessages = document.getElementById('chat-messages');
    const xorPuzzle = document.getElementById('xor-puzzle');
    const xorGrid = document.getElementById('xor-grid');
    const xorResult = document.getElementById('xor-result');
    const mapContainer = document.getElementById('map-container');
    const gpsTracker = document.getElementById('gps-tracker');
    const exportBtn = document.getElementById('export-pdf');

    // === –†–µ–∞–ª—å–Ω—ã–π –∑–≤—É–∫ —Ä–µ–∞–∫—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ Web Audio API ===
    let audioContext, gainNode, oscillator1, oscillator2, noiseBuffer;

    function initReactorSound() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        gainNode = audioContext.createGain();
        gainNode.gain.value = 0.15; // —Ç–∏—Ö–æ, –Ω–æ –æ—â—É—Ç–∏–º–æ

        // –û—Å–Ω–æ–≤–Ω–æ–π –≥—É–ª ~17 –ì—Ü (–∏–Ω—Ñ—Ä–∞–∑–≤—É–∫, –Ω–æ —Å–ª—ã—à–µ–Ω –∫–∞–∫ –≤–∏–±—Ä–∞—Ü–∏—è)
        oscillator1 = audioContext.createOscillator();
        oscillator1.type = 'sine';
        oscillator1.frequency.value = 17.3;

        // –ú–æ–¥—É–ª—è—Ü–∏—è + —à—É–º
        oscillator2 = audioContext.createOscillator();
        oscillator2.type = 'triangle';
        oscillator2.frequency.value = 0.3; // LFO

        const lfoGain = audioContext.createGain();
        lfoGain.gain.value = 2.0;
        oscillator2.connect(lfoGain);
        lfoGain.connect(oscillator1.frequency);

        // –ë–µ–ª—ã–π —à—É–º (–¥–ª—è "—Ç—Ä–µ—Å–∫–∞")
        const bufferSize = audioContext.sampleRate * 2; // 2 —Å–µ–∫—É–Ω–¥—ã
        const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
        const output = noiseBuffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
          output[i] = Math.random() * 2 - 1;
        }
        const noiseSource = new AudioBufferSourceNode(audioContext, { buffer: noiseBuffer });
        noiseSource.loop = true;
        const noiseGain = audioContext.createGain();
        noiseGain.gain.value = 0.03;

        // –°–æ–µ–¥–∏–Ω—è–µ–º
        oscillator1.connect(gainNode);
        noiseSource.connect(noiseGain);
        noiseGain.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator1.start();
        oscillator2.start();
        noiseSource.start();

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ "–∏–º–ø—É–ª—å—Å—ã" ‚Äî –∫–∞–∫ –ø–æ–º–µ—Ö–∏
        setInterval(() => {
          if (audioContext.state === 'running') {
            const impulse = audioContext.createBufferSource();
            const impulseBuffer = audioContext.createBuffer(1, 100, audioContext.sampleRate);
            const impulseData = impulseBuffer.getChannelData(0);
            for (let i = 0; i < 100; i++) impulseData[i] = Math.sin(i * 0.2) * Math.exp(-i / 20);
            impulse.buffer = impulseBuffer;
            const impGain = audioContext.createGain();
            impGain.gain.value = 0.2;
            impulse.connect(impGain);
            impGain.connect(gainNode);
            impulse.start();
          }
        }, 12000 + Math.random() * 8000);
      } catch (e) {
        console.warn("Audio init failed:", e);
      }
    }

    // –ó–∞–ø—É—Å–∫ –∑–≤—É–∫–∞ –ø–æ –∫–ª–∏–∫—É (–æ–±—Ö–æ–¥ –ø–æ–ª–∏—Ç–∏–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–≤)
    document.body.addEventListener('click', () => {
      if (!audioContext) initReactorSound();
    }, { once: true });

    // === UTILS ===
    function typeText(text, delay = 25, callback = null) {
      const lines = text.split('\n');
      let i = 0;
      const interval = setInterval(() => {
        if (i < lines.length) {
          log(lines[i]);
          i++;
        } else {
          clearInterval(interval);
          if (callback) setTimeout(callback, 300);
        }
      }, delay);
    }

    function log(msg, cls = '') {
      const now = new Date();
      const ts = `[${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().padStart(2,'0')}]`;
      terminal.innerHTML += `<div class="${cls}"><span class="timestamp">${ts}</span> ${msg}</div>`;
      terminal.scrollTop = terminal.scrollHeight;
    }

    function chat(msg, from = 'them') {
      const div = document.createElement('div');
      div.className = `chat-msg ${from}`;
      div.textContent = msg;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // === –°–¶–ï–ù–´ ===
    const scenes = {
      prelude: () => {
        typeText(`
> SYSTEM INIT ‚Äî TECH-PRIEST KERNEL v4.1
> LOADING PROFILE: DANYA "ELECTRON" VOLKOV
> LOCATION: MOSCOW, USSR ‚Äî 21 DEC 1991 ‚Äî 23:47

> BACKGROUND:
  - BURAN-4: CLASSIFIED SOVIET PROJECT (1985‚Äì1989)
  - OFFICIALLY: SHUTTLE UPGRADE
  - TRUTH: THORIUM REACTOR CORE "ZARYA-9" ‚Äî SELF-SUSTAINING, PSYCHOTROPIC EMISSIONS

> INTEL:
  - AMERICAN "LEAK" CONFIRMED: FALSE FLAG
  - COORDINATES PLANTED TO LURE INVESTIGATORS
  - 3 TEAMS VANISHED SINCE NOV 1991

> STATUS: NO FLASH DRIVE. NO CONTACT.

> AVAILABLE COMMANDS:
  [chat phantom] ‚Äî INITIATE SECURE CHANNEL
  [sysinfo]      ‚Äî SHOW TERMINAL STATUS
  [help]         ‚Äî LIST COMMANDS
        `.trim(), 30);
      },

      // === –ß–ê–¢ –° –•–ê–ö–ï–†–û–ú ===
      startChat: () => {
        chatPanel.classList.add('active');
        chatActive = true;
        chat("Connection established. Encryption: AES-256 + one-time pad.", 'them');
        chat("You‚Äôre late, Electron. Market‚Äôs hot tonight.", 'them');
        log("> SECURE CHANNEL OPEN ‚Äî AWAITING INPUT");
      },

      negotiate: (msg) => {
        const lower = msg.toLowerCase();
        if (lower.includes('price') || lower.includes('—Å–∫–æ–ª—å–∫–æ')) {
          chat("3 BTC. Or 5, if you want the *real* coordinates ‚Äî not the CIA plant.", 'them');
          chat("I know you‚Äôve got stash from that Mir hack.", 'them');
        } else if (lower.includes('where') || lower.includes('–≥–¥–µ')) {
          chat("Three options:", 'them');
          chat("1) Gorky Park ‚Äî dead drop (high risk: FSB patrols)", 'them');
          chat("2) Chernobyl Exclusion Zone ‚Äî old reactor office (radiation: 1.1 mSv/h)", 'them');
          chat("3) Baikonur perimeter ‚Äî fake guard post (most dangerous, but cleanest data)", 'them');
          chat("Choose. Timer starts now.", 'them');
        } else if (lower.includes('baikonur') || lower.includes('3')) {
          chat("Confirmed. Flash drive in locker #7, post 'Zarya'.", 'them');
          chat("Password: your birth year XOR 1984.", 'them');
          chat("Move fast. They‚Äôre watching the satellites.", 'them');
          setTimeout(() => {
            log("[SYS] FLASH DRIVE ACQUIRED. HASH: 7A3F...E9C1");
            phase = 'flash';
            localStorage.setItem('buran4_phase', phase);
            chatPanel.classList.remove('active');
            chatActive = false;
            scenes.flashIntro();
          }, 2000);
        } else if (lower.includes('park') || lower.includes('1')) {
          chat("...You hear sirens in the distance.", 'them');
          chat("Connection lost.", 'them');
          setTimeout(() => {
            log("[ALERT] FSB RAID ‚Äî TERMINAL COMPROMISED", 'err');
            log("> REBOOTING IN 5s...", 'warn');
            setTimeout(() => {
              terminal.innerHTML = '';
              phase = 'prelude';
              localStorage.setItem('buran4_phase', phase);
              scenes.prelude();
            }, 5000);
          }, 1500);
          return;
        } else {
          chat("Be specific. I don‚Äôt do riddles.", 'them');
        }
      },

      flashIntro: () => {
        typeText(`
> FLASH DRIVE INSERTED: USB 1.0 (Soviet clone)
> CONTENTS:
   - MAP_FRAGMENT_01.BIN        [LOCKED]
   - AUDIO_LOG_BURAN4_07.WAV    [CAUTION: Œîf=17.3Hz]
   - DECRYPT_KEY_XOR.PAD        [CORRUPT ‚Äî RECONSTRUCT REQUIRED]
   - _NOTE_FROM_PHANTOM.TXT     [READ]

> EXECUTING: cat _NOTE_FROM_PHANTOM.TXT
        `.trim(), 30, () => {
          setTimeout(() => {
            typeText(`
--- NOTE ---
Danya,

The key‚Äôs scrambled. Soviets used XOR with rotating seed.
Rebuild it ‚Äî the CRC32 must match: 0x9A3F2C1D.

If you fail, the map self-wipes.

And Danya‚Ä¶ if the reactor hum changes pitch ‚Äî *run*.

‚Äî P.
--- END ---
            `.trim(), 25, () => {
              log("\n> OPTIONS:");
              log("  [1] REPAIR XOR KEY");
              log("  [2] PLAY AUDIO LOG");
              log("  [3] ANALYZE MAP (LOCKED)");
            });
          }, 800);
        });
      },

      // === XOR –ì–û–õ–û–í–û–õ–û–ú–ö–ê ===
      showXOR: () => {
        xorPuzzle.classList.add('active');
        xorGrid.innerHTML = '';

        // –ò—Å—Ö–æ–¥–Ω—ã–µ –±–∞–π—Ç—ã (–ø–µ—Ä–µ–º–µ—à–∞–Ω—ã)
        const shuffled = ['1A', 'F3', '0C', 'B7', '88', '41', 'E2', 'D5'];
        const correct = ['1A', '0C', '41', '88', 'B7', 'E2', 'F3', 'D5']; // –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫

        shuffled.forEach(byte => {
          const el = document.createElement('div');
          el.className = 'xor-byte';
          el.textContent = byte;
          el.draggable = true;
          el.dataset.value = byte;

          el.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', byte);
            el.classList.add('dragging');
          });

          el.addEventListener('dragend', () => {
            el.classList.remove('dragging');
          });

          xorGrid.appendChild(el);
        });

        // –î—Ä–æ–ø–∑–æ–Ω—ã
        for (let i = 0; i < 8; i++) {
          const drop = document.createElement('div');
          drop.className = 'xor-dropzone';
          drop.dataset.index = i;
          drop.addEventListener('dragover', (e) => {
            e.preventDefault();
            drop.style.borderColor = '#0f0';
          });
          drop.addEventListener('dragleave', () => {
            drop.style.borderColor = '#080';
          });
          drop.addEventListener('drop', (e) => {
            e.preventDefault();
            const byte = e.dataTransfer.getData('text/plain');
            const dragged = xorGrid.querySelector(`[data-value="${byte}"]`);
            if (dragged && !drop.textContent) {
              drop.textContent = byte;
              dragged.style.display = 'none';
            }
            drop.style.borderColor = '#080';
          });
          xorGrid.appendChild(drop);
        }

        document.getElementById('xor-submit').onclick = () => {
          const order = Array.from(xorGrid.querySelectorAll('.xor-dropzone'))
            .map(d => d.textContent || '??');
          const crc = crc32(order.join(''));
          if (crc === 0x9A3F2C1D) {
            xorResult.innerHTML = '<span style="color:#afa">‚úì CRC MATCH ‚Äî KEY RECONSTRUCTED</span>';
            log("> KEY REPAIRED. MAP UNLOCKED.");
            xorSolved = true;
            setTimeout(() => {
              xorPuzzle.classList.remove('active');
              log("\n> EXECUTING: decrypt MAP_FRAGMENT_01.BIN");
              log("[OK] MAP DECRYPTED. DISPLAYING ROUTE...");
              setTimeout(() => scenes.showMap(), 1000);
            }, 1500);
          } else {
            xorResult.innerHTML = `<span class="err">‚úó CRC FAIL ‚Äî EXPECTED 0x9A3F2C1D, GOT 0x${crc.toString(16).toUpperCase().padStart(8,'0')}</span>`;
          }
        };
      },

      // === –ö–ê–†–¢–ê ===
      showMap: () => {
        mapContainer.classList.add('active');
        log("> INITIATING GPS ROUTE TO BURAN-4");
        log("  START: Baikonur Perimeter Gate");
        log("  TARGET: 45.6307¬∞N, 63.3322¬∞E");
        log("  DISTANCE: 14.3 km");

        setTimeout(() => {
          gpsRunning = true;
          gpsTracker.style.transition = 'left 12s linear';
          gpsTracker.style.left = '85%';

          // –¢—Ä–µ–≤–æ–≥–∏ –ø–æ –ø—É—Ç–∏
          setTimeout(() => {
            log("[WARN] RAD SPIKE ‚Äî 2.4 mSv/h", 'warn');
          }, 3000);

          setTimeout(() => {
            log("[ALERT] MOTION DETECTED ‚Äî 300m AHEAD", 'err');
            log("         [CAM-7] FEED LOST");
          }, 6000);

          setTimeout(() => {
            log("[SYS] ARRIVED AT COORDINATES");
            log("      STRUCTURE DETECTED: BURIED CONCRETE DOME (DIAM: 48m)");
            log("      ENTRANCE: AIRLOCK Œ® ‚Äî POWER: STANDBY");
            log("\n> FINAL COMMANDS:");
            log("  [open airlock] ‚Äî INITIATE ENTRY");
            log("  [scan perimeter] ‚Äî LOOK FOR TRAPS");
          }, 11000);
        }, 500);
      }
    };

    // === CRC32 (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è, –¥–ª—è –¥–µ–º–æ) ===
    function crc32(str) {
      let crc = 0xffffffff;
      const bytes = new TextEncoder().encode(str);
      for (let b of bytes) {
        crc ^= b;
        for (let i = 0; i < 8; i++) {
          crc = (crc & 1) ? (crc >>> 1) ^ 0xEDB88320 : crc >>> 1;
        }
      }
      return (~crc >>> 0);
    }

    // === –≠–ö–°–ü–û–†–¢ –í PDF ===
    exportBtn.onclick = () => {
      log("> GENERATING TECHNICAL PASSPORT...", 'sys');
      html2canvas(document.getElementById('passport')).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        pdf.setFont('helvetica');
        pdf.addImage(imgData, 'PNG', 10, 10, 190, 250);
        pdf.save('TECH-PRIEST_PASSPORT_ELECTRON.pdf');
        log("[OK] PASSPORT EXPORTED", 'sys');
      }).catch(e => {
        log(`[ERR] PDF EXPORT FAILED: ${e.message}`, 'err');
      });
    };

    // === –ö–û–ú–ê–ù–î–´ ===
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const cmd = input.value.trim();
        log(`> ${cmd}`);
        input.value = '';

        // –ß–∞—Ç –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –Ω–µ–≥–æ
        if (chatActive) {
          chat(cmd, 'me');
          scenes.negotiate(cmd);
          return;
        }

        // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
        switch (phase) {
          case 'prelude':
            if (cmd === 'chat phantom') {
              scenes.startChat();
            } else if (cmd === 'sysinfo') {
              log("TERMINAL: RETRO-91 KERNEL v2.1");
              log("MEMORY: 4 MB RAM (3.2 MB FREE)");
              log("STORAGE: 20 MB HDD (FLASH MOUNTED AT /dev/sdb1)");
              log("SOUND: REACTOR CORE SIM ‚Äî ACTIVE");
            } else if (cmd === 'help') {
              log("COMMANDS: chat phantom | sysinfo | help");
            } else {
              log("ERR: COMMAND NOT RECOGNIZED", 'err');
            }
            break;

          case 'flash':
            if (cmd === '1' || cmd === 'repair xor') {
              scenes.showXOR();
            } else if (cmd === '2' || cmd === 'play audio') {
              log("[AUD] ‚ñ∂ PLAYING AUDIO_LOG_BURAN4_07.WAV", 'sys');
              log("      [!] HEAR THAT PITCH SHIFT? IT‚ÄôS NOT SUPPOSED TO DO THAT.", 'warn');
            } else if (cmd === 'open airlock' && xorSolved) {
              log("> INITIATING AIRLOCK Œ® SEQUENCE...");
              log("[DOOR] HISS ‚Äî HYDRAULICS ENGAGED");
              log("[LIGHT] GREEN ‚Üí AMBER ‚Üí RED");
              log("[VOICE] *...welcome...home...* (distorted)");
              log("\n> [ENTER] TO STEP INSIDE ‚Äî OR TYPE 'abort'");
              // ‚Üí –°–ª–µ–¥—É—é—â–∞—è —Ñ–∞–∑–∞: –≤–Ω—É—Ç—Ä—å —Ä–µ–∞–∫—Ç–æ—Ä–∞...
            } else {
              log("ERR: MAP LOCKED ‚Äî REPAIR KEY FIRST", 'err');
            }
            break;

          default:
            log("ERR: UNKNOWN STATE", 'err');
        }
      }
    });

    // === –°–¢–ê–†–¢ ===
    window.addEventListener('load', () => {
      log("> BOOTING TECH-PRIEST TERMINAL...", 'sys');
      setTimeout(() => {
        if (phase === 'flash') {
          scenes.flashIntro();
        } else {
          scenes.prelude();
        }
      }, 800);
    });
  </script>
</body>
</html>
