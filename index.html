<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ë–£–†–ê–ù-4 // FINAL PHASE</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --green: #0f0;
      --dark: #0a0a0a;
      --darker: #030303;
      --red: #f33;
      --amber: #ffaa00;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background-color: var(--darker);
      color: var(--green);
      font-family: 'Share Tech Mono', monospace;
      overflow: hidden;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .monitor, .reactor-scene { transition: filter 0.5s ease; }
    .monitor.sanity-2 { filter: hue-rotate(30deg) saturate(1.3); }
    .monitor.sanity-1 { filter: hue-rotate(80deg) saturate(1.6) contrast(1.2); }
    .monitor.sanity-0 { filter: hue-rotate(180deg) saturate(0.4) brightness(0.7); }

    .monitor {
      width: 94vw;
      max-width: 900px;
      height: 94vh;
      background-color: var(--dark);
      border: 10px solid #111;
      box-shadow: 
        0 0 30px rgba(0, 80, 0, 0.7), 
        inset 0 0 15px rgba(0, 40, 0, 0.8),
        inset 0 0 40px rgba(0, 20, 0, 0.3);
      position: relative;
      overflow: hidden;
      padding: 20px;
      border-radius: 4px;
      font-size: 15px;
      z-index: 10;
    }

    .monitor::before {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(rgba(0, 30, 0, 0.08), transparent 95%);
      pointer-events: none;
      animation: scanline 9s linear infinite;
    }

    @keyframes scanline {
      0% { background-position: 0 0; }
      100% { background-position: 0 100vh; }
    }

    .header {
      text-align: center;
      margin-bottom: 18px;
      font-family: 'Orbitron', sans-serif;
      font-size: 1.5rem;
      text-shadow: 0 0 6px rgba(0, 255, 0, 0.8), 0 0 12px rgba(0, 120, 0, 0.6);
      letter-spacing: 2px;
    }

    .terminal {
      line-height: 1.6;
      height: calc(100% - 140px);
      overflow-y: auto;
      padding: 12px;
      color: var(--green);
      text-shadow: 0 0 3px rgba(0, 60, 0, 0.8);
      white-space: pre-wrap;
    }

    .blink { animation: blink 1s step-end infinite; }
    @keyframes blink { 50% { opacity: 0; } }

    .input-line {
      margin-top: 10px;
      display: flex;
      align-items: center;
    }

    .prompt::after {
      content: '‚ñà';
      margin-right: 8px;
      animation: blink 1s step-end infinite;
    }

    input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--green);
      font-family: 'Share Tech Mono', monospace;
      font-size: 1.1rem;
      outline: none;
      text-shadow: 0 0 3px rgba(0, 60, 0, 0.8);
    }

    .timestamp { color: #8f8; font-size: 0.85rem; opacity: 0.8; }
    .sys { color: #8af; }
    .err { color: var(--red); }
    .warn { color: var(--amber); }

    /* –ß–∞—Ç */
    .chat-panel {
      position: absolute;
      top: 20px; right: 20px;
      width: 280px;
      height: 320px;
      background: rgba(5, 15, 5, 0.9);
      border: 2px solid var(--green);
      box-shadow: 0 0 8px rgba(0, 255, 0, 0.4);
      padding: 12px;
      font-size: 0.85rem;
      display: none;
      z-index: 11;
      overflow-y: auto;
    }

    .chat-panel.active { display: block; }
    .chat-msg { margin-bottom: 10px; line-height: 1.4; }
    .chat-msg.me { text-align: right; color: #afa; }
    .chat-msg.them { text-align: left; color: #8af; }
    .chat-header {
      text-align: center;
      font-weight: bold;
      margin-bottom: 8px;
      border-bottom: 1px dashed #0a0;
      padding-bottom: 4px;
      font-family: 'Orbitron', sans-serif;
    }

    /* Reactor scene (A-Frame) ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞ */
    .reactor-scene {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 5;
      display: none;
    }

    .reactor-scene.active {
      display: block;
    }

    /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Ä–µ–∞–∫—Ç–æ—Ä–∞ (–ø–æ–≤–µ—Ä—Ö 3D) */
    .in-scene-panel {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 10, 0, 0.7);
      border: 1px solid #0a0;
      padding: 12px 20px;
      border-radius: 4px;
      font-family: 'Share Tech Mono';
      font-size: 1rem;
      color: var(--green);
      z-index: 20;
      max-width: 80vw;
    }

    .in-scene-input {
      background: transparent;
      border: none;
      color: #afa;
      font-family: 'Share Tech Mono';
      font-size: 1rem;
      outline: none;
      width: 100%;
      margin-top: 6px;
    }

    /* Sanity bar */
    .sanity-bar {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 20;
    }

    .sanity-label {
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .sanity-progress {
      height: 8px;
      width: 120px;
      background: #222;
      border-radius: 4px;
      overflow: hidden;
    }

    .sanity-fill {
      height: 100%;
      background: linear-gradient(to right, #f33, #ff0, #0f0);
      width: 100%;
      transition: width 0.5s;
    }

    /* –≠–∫—Å–ø–æ—Ä—Ç */
    .export-btn {
      position: absolute;
      bottom: 15px; right: 15px;
      background: #111;
      color: var(--amber);
      border: 1px solid var(--amber);
      padding: 6px 12px;
      font-family: 'Orbitron';
      font-size: 0.8rem;
      cursor: pointer;
    }

    /* Passport (—Å–∫—Ä—ã—Ç) */
    #passport {
      position: absolute;
      left: -9999px;
      width: 700px;
      padding: 40px;
      background: #0a0a0a;
      font-family: 'Cinzel', serif;
      color: #ccc;
      border: 4px double #888;
    }

    .passport-header { text-align: center; font-size: 2.2rem; color: #f33; margin-bottom: 20px; }
    .passport-field { margin: 12px 0; font-size: 1.1rem; }
    .field-label { color: #8af; font-weight: bold; }
    .field-value { color: #afa; }
    .seal { text-align: center; margin-top: 30px; font-family: 'Orbitron'; color: #f33; font-size: 1.4rem; }

    @media (max-width: 650px) {
      .chat-panel { width: 90vw; left: 50%; transform: translateX(-50%); top: auto; bottom: 120px; height: 180px; }
    }
  </style>
</head>
<body>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–Ω–∏—Ç–æ—Ä (—Ñ–∞–∑—ã 0-2) -->
  <div class="monitor" id="monitor">
    <div class="header" id="header">[ TECH-PRIEST MONITORING TERMINAL v4.1 | BURAN-4 RECON ]</div>
    <div class="terminal" id="terminal"></div>
    <div class="input-line">
      <span class="prompt"></span>
      <input type="text" id="command-input" placeholder=">_"
        autocomplete="off" spellcheck="false">
    </div>
    <div class="reactor-glow">
      <div class="glow-dot"></div>
      <span id="reactor-status">REACTOR CORE // NOMINAL (Œ¥ = 0.92)</span>
    </div>
    <div class="sanity-bar">
      <div class="sanity-label">SANITY: <span id="sanity-value">100</span>%</div>
      <div class="sanity-progress"><div class="sanity-fill" id="sanity-fill"></div></div>
    </div>
    <button class="export-btn" id="export-pdf">üñ® EXPORT TECH-PASSPORT</button>

    <div class="chat-panel" id="chat-panel">
      <div class="chat-header">> SECURE CHANNEL // PHANTOM</div>
      <div class="chat-messages" id="chat-messages"></div>
    </div>
  </div>

  <!-- –§–∞–∑–∞ 3: –†–µ–∞–∫—Ç–æ—Ä (3D) -->
  <div class="reactor-scene" id="reactor-scene">
    <a-scene
      renderer="antialias: true; physicallyCorrectLights: false;"
      fog="type: exponential; color: #000; density: 0.02"
      class="fullscreen"
    >
      <!-- –ö–∞–º–µ—Ä–∞ —Å –∫—É—Ä—Å–æ—Ä–æ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
      <a-entity id="rig" position="0 1.6 5">
        <a-camera
          position="0 0 0"
          look-controls
          wasd-controls="acceleration: 20"
          cursor="rayOrigin: mouse"
        ></a-camera>
      </a-entity>

      <!-- –û—Å–Ω–æ–≤–∞–Ω–∏–µ ‚Äî –±–µ—Ç–æ–Ω–Ω—ã–π –ø–æ–ª -->
      <a-plane
        position="0 0 0"
        rotation="-90 0 0"
        width="40"
        height="40"
        color="#222"
        shader="flat"
      ></a-plane>

      <!-- –°—Ç–µ–Ω—ã ‚Äî –º–∞—Å—Å–∏–≤–Ω—ã–µ –±–µ—Ç–æ–Ω–Ω—ã–µ –ø–ª–∏—Ç—ã -->
      <a-box position="-10 2 0" width="1" height="4" depth="20" color="#333" roughness="1"></a-box>
      <a-box position="10 2 0" width="1" height="4" depth="20" color="#333" roughness="1"></a-box>
      <a-box position="0 2 -10" width="20" height="4" depth="1" color="#333" roughness="1"></a-box>
      <a-box position="0 2 10" width="20" height="4" depth="1" color="#333" roughness="1"></a-box>

      <!-- –°–µ—Ä–¥—Ü–µ–≤–∏–Ω–∞ —Ä–µ–∞–∫—Ç–æ—Ä–∞ (–ø—É–ª—å—Å–∏—Ä—É—é—â–∞—è) -->
      <a-entity id="core" position="0 2 0">
        <a-sphere
          radius="1.2"
          color="#f33"
          metalness="0.8"
          roughness="0.2"
          animation="property: scale; from: 1 1 1; to: 1.05 1.05 1.05; dur: 1200; easing: easeInOutSine; loop: true; dir: alternate"
        ></a-sphere>
        <a-sphere
          radius="1.8"
          color="#f66"
          opacity="0.2"
          animation="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; dur: 3000; easing: easeInOutSine; loop: true; dir: alternate"
        ></a-sphere>
      </a-entity>

      <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
      <a-plane
        id="panel"
        position="4 1.5 -2"
        rotation="0 90 0"
        width="2"
        height="1.2"
        color="#111"
        shader="flat"
      >
        <a-text
          value="ACCESS PANEL"
          position="0 0.4 0.01"
          color="#0f0"
          align="center"
          width="2"
          font="https://cdn.aframe.io/fonts/monoid.fnt"
        ></a-text>
        <a-text
          value="STATUS: LOCKED"
          id="panel-status"
          position="0 0 0.01"
          color="#8af"
          align="center"
          width="2"
          font="https://cdn.aframe.io/fonts/monoid.fnt"
        ></a-text>
      </a-plane>

      <!-- –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–≤–µ—Ç–∞ -->
      <a-light
        type="point"
        color="#ffaa00"
        intensity="0.8"
        position="0 3 0"
      ></a-light>
      <a-light
        type="ambient"
        color="#111"
      ></a-light>
    </a-scene>

    <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ —Å—Ü–µ–Ω—ã -->
    <div class="in-scene-panel" id="in-scene-panel">
      > REACTOR CONTROL // SANITY: <span id="in-scene-sanity">100</span>%
      <br>Type command: <span class="blink">‚ñà</span>
      <input type="text" class="in-scene-input" id="in-scene-input" placeholder="e.g. scan panel, open airlock, msg phantom...">
    </div>
  </div>

  <!-- –ü–∞—Å–ø–æ—Ä—Ç (–¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞) -->
  <div id="passport">
    <div class="passport-header">ORDO MECHANICUS TECHNICAL PASSPORT</div>
    <div class="passport-field"><span class="field-label">NAME:</span> <span class="field-value">DANYA "ELECTRON" VOLKOV</span></div>
    <div class="passport-field"><span class="field-label">RANK:</span> <span class="field-value">SCRIBE-ANALYST (PROVISIONAL)</span></div>
    <div class="passport-field"><span class="field-label">MISSION:</span> <span class="field-value">BURAN-4 RECON / ZARYA-9 REACTOR</span></div>
    <div class="passport-field"><span class="field-label">COORDINATES:</span> <span class="field-value">45.6307¬∞N, 63.3322¬∞E</span></div>
    <div class="passport-field"><span class="field-label">SANITY:</span> <span class="field-value" id="passport-sanity">100%</span></div>
    <div class="passport-field"><span class="field-label">WARNINGS:</span> <span class="field-value">RADIATION ‚Ä¢ PSYCHIC ECHO ‚Ä¢ NO RETURN PROTOCOL</span></div>
    <div class="seal">‚ú† MACHINA SACRA ‚ú†</div>
  </div>

  <script>
    // === –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===
    let state = JSON.parse(localStorage.getItem('buran4_state')) || {
      phase: 'prelude',
      sanity: 100,
      xorSolved: false,
      gpsDone: false,
      language: 'ru',
      chatHistory: []
    };

    // === DOM ===
    const monitor = document.getElementById('monitor');
    const reactorScene = document.getElementById('reactor-scene');
    const terminal = document.getElementById('terminal');
    const input = document.getElementById('command-input');
    const inSceneInput = document.getElementById('in-scene-input');
    const chatPanel = document.getElementById('chat-panel');
    const chatMessages = document.getElementById('chat-messages');
    const sanityFill = document.getElementById('sanity-fill');
    const sanityValue = document.getElementById('sanity-value');
    const inSceneSanity = document.getElementById('in-scene-sanity');
    const passportSanity = document.getElementById('passport-sanity');
    const panelStatus = document.getElementById('panel-status');
    const exportBtn = document.getElementById('export-pdf');

    // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∞–Ω–∏—Ç–∏ ===
    function updateSanity(delta = 0) {
      state.sanity = Math.max(0, Math.min(100, state.sanity + delta));
      sanityFill.style.width = `${state.sanity}%`;
      sanityValue.textContent = Math.round(state.sanity);
      inSceneSanity.textContent = Math.round(state.sanity);
      passportSanity.textContent = `${Math.round(state.sanity)}%`;
      
      // –î–µ–≥—Ä–∞–¥–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      monitor.className = 'monitor';
      if (state.sanity <= 70) monitor.classList.add('sanity-2');
      if (state.sanity <= 40) monitor.classList.add('sanity-1');
      if (state.sanity <= 15) monitor.classList.add('sanity-0');

      // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è
      if (state.sanity <= 0) {
        log("[SYS] SANITY CRITICAL ‚Äî AUTONOMOUS PROTOCOL ENGAGED", 'err');
        setTimeout(() => {
          log("> EXECUTING: merge_with_machine --force", 'sys');
          showEnding('merge');
        }, 2000);
      }
    }

    // === –õ–æ–≥–≥–µ—Ä ===
    function log(msg, cls = '') {
      const now = new Date();
      const ts = `[${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().padStart(2,'0')}]`;
      terminal.innerHTML += `<div class="${cls}"><span class="timestamp">${ts}</span> ${msg}</div>`;
      terminal.scrollTop = terminal.scrollHeight;
    }

    // === –ß–∞—Ç ===
    function chat(msg, from = 'them') {
      const div = document.createElement('div');
      div.className = `chat-msg ${from}`;
      div.textContent = msg;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      state.chatHistory.push({ from, msg });
    }

    // === –ì–æ–ª–æ—Å–∞ (–ø—Ä–æ—Å—Ç–∞—è –∏–º–∏—Ç–∞—Ü–∏—è) ===
    function playVoice(text, delay = 0) {
      setTimeout(() => {
        log(`[VOICE] "${text}" ‚Äî (direction: unknown)`, 'warn');
        updateSanity(-8);
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å Web Speech API –∏–ª–∏ –∞—É–¥–∏–æ—Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã
      }, delay);
    }

    // === –§–∏–Ω–∞–ª—ã ===
    function showEnding(type) {
      let title, desc;
      if (type === 'escape') {
        title = "FINAL TRANSMISSION ‚Äî ESCAPE";
        desc = "–í—ã –≤—ã–±–µ–∂–∞–ª–∏ –Ω–∞—Ä—É–∂—É. –í–æ—Ä–æ—Ç–∞ –∑–∞—Ö–ª–æ–ø–Ω—É–ª–∏—Å—å. –ó–∞ —Å–ø–∏–Ω–æ–π ‚Äî –≤–æ–π —Å–∏—Ä–µ–Ω –∏ –≥—É–ª, —Ä–∞—Å—Ç—É—â–∏–π –≤ –æ–∫—Ç–∞–≤–µ.\n\nPhantom: \"–¢—ã –ø—Ä–∏–Ω—ë—Å –¥–∞–Ω–Ω—ã–µ. –ù–æ —Ç—ã –Ω–µ —Ç–æ—Ç, –∫–µ–º –±—ã–ª.\"\n\n[–§–ê–ô–õ –ü–†–ò–ö–†–ï–ü–õ–ï–ù: BURAN4_CORE_DUMP.bin]";
      } else if (type === 'stay') {
        title = "FINAL TRANSMISSION ‚Äî OBSERVATION";
        desc = "–í—ã –æ—Å—Ç–∞–ª–∏—Å—å. –ù–∞–±–ª—é–¥–∞–µ—Ç–µ. –°–µ—Ä–¥—Ü–µ–≤–∏–Ω–∞ –ø—É–ª—å—Å–∏—Ä—É–µ—Ç –≤ —Ä–∏—Ç–º–µ –≤–∞—à–µ–≥–æ —Å–µ—Ä–¥—Ü–∞.\n\n–°—Ç–µ–Ω—ã —à–µ–ø—á—É—Ç: *¬´–û–Ω –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è¬ª*.\n\n–í—ã –±–æ–ª—å—à–µ –Ω–µ —á–µ–ª–æ–≤–µ–∫. –í—ã ‚Äî —Å—Ç–æ—Ä–æ–∂.\n\n[–°–¢–ê–¢–£–°: STANDBY // INFINITE]";
      } else {
        title = "FINAL TRANSMISSION ‚Äî MERGE";
        desc = "–í—ã –≤–≤–µ–ª–∏ –∫–æ–º–∞–Ω–¥—É. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–∞—Å—Ç–≤–æ—Ä–∏–ª—Å—è.\n\n–í–∞—à–∏ —Ä—É–∫–∏ ‚Äî –ø—Ä–æ–≤–æ–¥–∞. –ì–ª–∞–∑–∞ ‚Äî –ª–∏–Ω–∑—ã. –ú—ã—Å–ª–∏ ‚Äî –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö.\n\n*¬´–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –¥–æ–º–æ–π, –≠–ª–µ–∫—Ç—Ä–æ–Ω¬ª*\n\n[–°–¢–ê–¢–£–°: UNIT Œ®-7 // ONLINE]";
      }

      reactorScene.classList.remove('active');
      monitor.classList.add('active');
      terminal.innerHTML = `
        <div class="sys" style="text-align:center; font-size:1.8rem; margin:20px 0;">${title}</div>
        <div style="white-space:pre-line; margin:20px 0;">${desc}</div>
        <div style="text-align:center; margin-top:30px;">
          <button onclick="location.reload()" style="padding:10px 20px; background:#222; border:1px solid #0f0;">üîÅ RESTART</button>
        </div>
      `;
    }

    // === –§–∞–∑—ã ===
    const phases = {
      prelude: () => {
        log("> SYSTEM INIT ‚Äî TECH-PRIEST KERNEL v4.1", 'sys');
        log("> PROFILE: DANYA \"ELECTRON\" VOLKOV", 'sys');
        log("> DATE: 21 DEC 1991 ‚Äî 23:47", 'sys');
        log("\n> COMMANDS:");
        log("  [chat phantom] ‚Äî negotiate");
        log("  [lang en]      ‚Äî switch language");
        log("  [help]         ‚Äî show help");
      },

      chat: () => {
        chatPanel.classList.add('active');
        chat("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ: AES-256.", 'them');
        chat("–¢—ã –æ–ø–æ–∑–¥–∞–ª, –≠–ª–µ–∫—Ç—Ä–æ–Ω. –†—ã–Ω–æ–∫ –≥–æ—Ä–∏—Ç.", 'them');
      },

      insideReactor: () => {
        monitor.style.display = 'none';
        reactorScene.classList.add('active');
        log("> AIRLOCK Œ® OPEN ‚Äî WELCOME TO ZARYA-9", 'sys');
        updateSanity(-5);

        setTimeout(() => playVoice("–î–∞–Ω—è‚Ä¶ —Ç—ã –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã–ª –ø—Ä–∏—Ö–æ–¥–∏—Ç—å‚Ä¶", 2000), 1000);
        setTimeout(() => playVoice("–û–Ω –∑–Ω–∞–µ—Ç, —á—Ç–æ —Ç—ã –∑–¥–µ—Å—å.", 5000), 1000);
      }
    };

    // === –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ ===
    function handleCommand(cmd, fromScene = false) {
      const lower = cmd.toLowerCase().trim();
      const srcInput = fromScene ? inSceneInput : input;
      if (!fromScene) log(`> ${cmd}`);

      // –ö–æ–º–∞–Ω–¥—ã –≤–Ω—É—Ç—Ä–∏ —Ä–µ–∞–∫—Ç–æ—Ä–∞
      if (state.phase === 'reactor') {
        if (lower === 'scan panel' || lower === '–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–∞–Ω–µ–ª—å') {
          log("> SCANNING CONTROL PANEL‚Ä¶", 'sys');
          log("  MODEL: ZARYA-9 CMD UNIT v3 (1987)");
          log("  LOCK: XOR-KEY REQUIRED (SEE FLASH DRIVE)");
          log("  WARNING: PSYCHIC DAMPING ‚Äî 43% DEGRADED");
          updateSanity(-3);
        } else if (lower === 'open airlock' || lower === '–æ—Ç–∫—Ä—ã—Ç—å —à–ª—é–∑') {
          log("[DOOR] HISS ‚Äî HYDRAULICS ENGAGED", 'sys');
          log("[LIGHT] GREEN ‚Üí AMBER ‚Üí RED", 'warn');
          log("[VOICE] *‚Ä¶welcome‚Ä¶home‚Ä¶*", 'warn');
          updateSanity(-10);
          setTimeout(() => phases.insideReactor(), 1500);
        } else if (lower.startsWith('msg phantom') || lower.startsWith('–Ω–∞–ø–∏—Å–∞—Ç—å —Ö–∞–∫–µ—Ä—É')) {
          const msg = cmd.split(' ').slice(2).join(' ') || 'help';
          chat(msg, 'me');
          setTimeout(() => {
            if (state.sanity > 80) {
              chat("–Ø –≤–∏–∂—É —Ç–≤–æ–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã. –ë–µ–≥–∏. –°–µ–π—á–∞—Å.", 'them');
            } else if (state.sanity > 50) {
              chat("–°–∏–≥–Ω–∞–ª –∏—Å–∫–∞–∂—ë–Ω‚Ä¶ –Ø —Å–ª—ã—à—É‚Ä¶ *–≥–æ–ª–æ—Å–∞*‚Ä¶", 'them');
            } else {
              chat("‚Ä¶—Ç—ã —É–∂–µ –Ω–µ –î–∞–Ω—è‚Ä¶", 'them');
            }
            updateSanity(-5);
          }, 2000);
        } else if (lower === 'status' || lower === '—Å—Ç–∞—Ç—É—Å') {
          log(`> SANITY: ${Math.round(state.sanity)}%`);
          log(`> LOCATION: AIRLOCK Œ®`);
          log(`> CORE STATUS: PULSING (17.3 Hz)`);
        } else if (lower === 'escape' || lower === '—Å–±–µ–∂–∞—Ç—å') {
          showEnding('escape');
        } else if (lower === 'stay' || lower === '–æ—Å—Ç–∞—Ç—å—Å—è') {
          showEnding('stay');
        } else if (lower === 'merge' || lower === '—Å–ª–∏—Ç—å—Å—è') {
          showEnding('merge');
        } else {
          log("ERR: COMMAND NOT RECOGNIZED", 'err');
        }
        srcInput.value = '';
        return;
      }

      // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
      if (lower === 'chat phantom') {
        state.phase = 'chat';
        phases.chat();
      } else if (lower === 'lang en') {
        state.language = 'en';
        document.querySelector('.header').textContent = '[ TECH-PRIEST MONITORING TERMINAL v4.1 | BURAN-4 RECON ]';
      } else if (lower === 'lang ru') {
        state.language = 'ru';
        document.querySelector('.header').textContent = '[ –¢–ï–•–ù–û-–°–í–Ø–©–ï–ù–ù–ò–ß–ï–°–ö–ò–ô –¢–ï–†–ú–ò–ù–ê–õ v4.1 | –†–ê–ó–í–ï–î–ö–ê –ë–£–†–ê–ù-4 ]';
      } else if (lower === 'help' || lower === '–ø–æ–º–æ—â—å') {
        log("–î–û–°–¢–£–ü–ù–´–ï –ö–û–ú–ê–ù–î–´:");
        log("  chat phantom ‚Äî –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã");
        log("  lang en/ru   ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —è–∑—ã–∫");
        log("  sysinfo      ‚Äî —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã");
      } else if (lower === 'sysinfo' || lower === '—Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã') {
        log("–¢–ï–†–ú–ò–ù–ê–õ: RETRO-91 KERNEL v2.1");
        log(`–ó–î–û–†–û–í–¨–ï: ${Math.round(state.sanity)}%`);
        log("–ü–ê–ú–Ø–¢–¨: 4 –ú–ë (3.2 –ú–ë –°–í–û–ë–û–î–ù–û)");
      } else if (state.phase === 'chat') {
        chat(cmd, 'me');
        if (lower.includes('baikonur') || lower.includes('3')) {
          chat("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ. –§–ª–µ—à–∫–∞ –≤ —è—â–∏–∫–µ #7.", 'them');
          state.phase = 'flash';
          setTimeout(() => {
            log("[SYS] –§–õ–ï–®–ö–ê –ü–û–õ–£–ß–ï–ù–ê. –•–ï–®: 7A3F...E9C1", 'sys');
            log("> –°–û–î–ï–†–ñ–ò–ú–û–ï:");
            log("   - MAP_FRAGMENT_01.BIN        [–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù]");
            log("   - DECRYPT_KEY_XOR.PAD        [–ü–û–í–†–ï–ñ–î–Å–ù]");
            log("   - _NOTE_FROM_PHANTOM.TXT     [–ü–†–û–ß–ò–¢–ê–¢–¨]");
            chatPanel.classList.remove('active');
          }, 2000);
        }
      } else if (state.phase === 'flash' && (lower === 'open airlock' || lower === '–æ—Ç–∫—Ä—ã—Ç—å —à–ª—é–∑')) {
        state.phase = 'reactor';
        localStorage.setItem('buran4_state', JSON.stringify(state));
        log("> –ò–ù–ò–¶–ò–ê–¶–ò–Ø –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–ò –®–õ–Æ–ó–ê Œ®‚Ä¶", 'sys');
        setTimeout(() => handleCommand('open airlock', true), 1500);
      } else {
        log("ERR: –ö–û–ú–ê–ù–î–ê –ù–ï –†–ê–°–ü–û–ó–ù–ê–ù–ê", 'err');
      }

      srcInput.value = '';
    }

    // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–≤–æ–¥–∞ ===
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handleCommand(input.value);
    });

    inSceneInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handleCommand(inSceneInput.value, true);
    });

    // === –≠–∫—Å–ø–æ—Ä—Ç PDF ===
    exportBtn.onclick = () => {
      log("> –ì–ï–ù–ï–†–ê–¶–ò–Ø –¢–ï–•–ù–û-–ü–ê–°–ü–û–†–¢–ê‚Ä¶", 'sys');
      html2canvas(document.getElementById('passport')).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        pdf.addImage(imgData, 'PNG', 10, 10, 190, 250);
        pdf.save(`TECH-PASSPORT_ELECTRON_${Math.round(state.sanity)}pct.pdf`);
        log("[OK] –ü–ê–°–ü–û–†–¢ –≠–ö–°–ü–û–†–¢–ò–†–û–í–ê–ù", 'sys');
      });
    };

    // === Service Worker –¥–ª—è –æ—Ñ–ª–∞–π–Ω ===
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => console.warn('SW failed:', err));
      // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë–º sw.js
      const swContent = `
        self.addEventListener('install', e => e.waitUntil(self.skipWaiting()));
        self.addEventListener('activate', e => e.waitUntil(clients.claim()));
        self.addEventListener('fetch', () => {}); // –ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞ ‚Äî –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å
      `;
      const blob = new Blob([swContent], { type: 'application/javascript' });
      const url = URL.createObjectURL(blob);
      // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ sw.js –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    }

    // === –°–¢–ê–†–¢ ===
    updateSanity(0); // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    if (state.phase === 'reactor') {
      phases.insideReactor();
    } else {
      phases.prelude();
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫
    setInterval(() => {
      localStorage.setItem('buran4_state', JSON.stringify(state));
    }, 2000);
  </script>
</body>
</html>
